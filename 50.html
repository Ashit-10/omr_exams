<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MCQ OMR Sheet</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
    }
    .question {
      border: 1px solid #ccc;
      padding: 12px;
      margin-bottom: 10px;
    }
    .options label {
      display: block;
      margin-bottom: 4px;
    }
    #resetBtn {
      position: fixed;
      top: 10px;
      right: 10px;
      z-index: 1000;
      padding: 8px 12px;
      background: #ff5b5b;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
  </style>
</head>
<body>

<h1>MCQ OMR Sheet</h1>

<div id="questions-container">
  <!-- Questions will be inserted here -->
</div>

<script>
// ========== Core Question Logic ==========
const questionFile = "question.txt";
const answerFile = "answer.txt";

function loadTextFile(filePath, callback) {
  fetch(filePath)
    .then(res => {
      if (!res.ok) throw new Error(`${filePath} not found`);
      return res.text();
    })
    .then(text => callback(null, text))
    .catch(err => callback(err));
}

function parseQuestions(text) {
  const blocks = text.trim().split(/\n\s*\n/);
  return blocks.map((block, index) => {
    const lines = block.split("\n");
    const qText = lines[0].replace(/^\d+\.\s*/, '');
    const options = lines.slice(1).map(line => {
      const match = line.match(/^[A-D]\)(.*)/);
      return match ? match[1].trim() : line.trim();
    });
    return { qText, options, index };
  });
}

function renderQuestions(questions) {
  const container = document.getElementById("questions-container");
  container.innerHTML = "";
  questions.forEach((q, idx) => {
    const div = document.createElement("div");
    div.className = "question";
    div.innerHTML = `<strong>${idx + 1}. ${q.qText}</strong><div class="options"></div>`;
    const opts = div.querySelector(".options");
    ["A", "B", "C", "D"].forEach((opt, i) => {
      const label = document.createElement("label");
      label.innerHTML = `
        <input type="checkbox" name="q${idx}" value="${opt}"> ${opt}) ${q.options[i] || ''}
      `;
      opts.appendChild(label);
    });
    container.appendChild(div);
  });
}

// ========== Auto Save Logic ==========

document.addEventListener("DOMContentLoaded", function () {
  const urlParams = new URLSearchParams(window.location.search);
  const dataSaveEnabled = urlParams.get("data") === "save";
  const filename = urlParams.get("filename") || "default";
  const localSaveKey = `omr_local_${filename}`;

  if (dataSaveEnabled) {
    const resetBtn = document.createElement("button");
    resetBtn.id = "resetBtn";
    resetBtn.innerText = "Reset";
    document.body.appendChild(resetBtn);

    resetBtn.addEventListener("click", () => {
      if (confirm("Reset all saved data?")) {
        localStorage.removeItem(localSaveKey);
        location.reload();
      }
    });
  }

  function saveLocally() {
    if (!dataSaveEnabled) return;
    const data = [];
    document.querySelectorAll(".question").forEach((q, i) => {
      const checked = Array.from(q.querySelectorAll("input:checked")).map(cb => cb.value);
      data[i] = checked;
    });
    localStorage.setItem(localSaveKey, JSON.stringify(data));
  }

  function restoreSelections() {
    const saved = localStorage.getItem(localSaveKey);
    if (!saved) return;
    try {
      const parsed = JSON.parse(saved);
      document.querySelectorAll(".question").forEach((q, i) => {
        const checkboxes = q.querySelectorAll("input[type='checkbox']");
        if (!parsed[i]) return;
        checkboxes.forEach(cb => {
          cb.checked = parsed[i].includes(cb.value);
        });
      });
    } catch (e) {
      console.error("Failed to restore saved data:", e);
    }
  }

  function attachAutoSaveListeners() {
    if (!dataSaveEnabled) return;
    document.querySelectorAll(".question input[type='checkbox']").forEach(cb => {
      cb.addEventListener("change", saveLocally);
    });
  }

  // Load questions
  loadTextFile(questionFile, (err, questionText) => {
    if (err) {
      document.getElementById("questions-container").innerText = "Failed to load questions.";
      return;
    }
    const questions = parseQuestions(questionText);
    renderQuestions(questions);

    // Restore and save
    restoreSelections();
    attachAutoSaveListeners();
  });
});
</script>

</body>
</html>
