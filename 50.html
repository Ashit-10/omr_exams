<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Answer Sheet Viewer</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f8f8;
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 900px;
            margin: 30px auto;
            background-color: #fff;
            padding: 20px 30px;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
        }

        h2 {
            text-align: center;
            color: #2c3e50;
        }

        .question {
            margin-bottom: 20px;
            padding: 15px;
            border-left: 6px solid #ccc;
            background-color: #fdfdfd;
            border-radius: 8px;
            transition: background-color 0.3s ease;
        }

        .question p {
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }

        label {
            display: block;
            margin-bottom: 8px;
            padding-left: 5px;
            color: #444;
        }

        .green {
            border-left-color: #27ae60;
            background-color: #eafaf1;
        }

        .blue {
            border-left-color: #2980b9;
            background-color: #ecf5fc;
        }

        .red {
            border-left-color: #c0392b;
            background-color: #fdecea;
        }

        .button-container {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
        }

        .action-button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .action-button:hover {
            background-color: #2980b9;
        }

        #result-container {
            margin-top: 30px;
            text-align: center;
        }

        .question-number {
            font-size: 1.1em;
            margin-right: 6px;
            color: #555;
        }

        @media (max-width: 600px) {
            .container {
                margin: 15px;
                padding: 15px 20px;
            }

            .action-button {
                padding: 10px 16px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>Answer Sheet Viewer</h2>
        <div id="questions-container"></div>

        <div class="button-container">
            <button id="saveButton" class="action-button">Save</button>
            <button id="resetButton" class="action-button">Reset</button> <!-- ✅ Reset Button Added -->
        </div>

        <div id="result-container"></div>
    </div>

    <script>
        const questionsContainer = document.getElementById('questions-container');
        const saveButton = document.getElementById('saveButton');
        const resetButton = document.getElementById('resetButton');
        const resultContainer = document.getElementById('result-container');

        function getQueryParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        const filename = getQueryParameter('filename');
        const autoSaveEnabled = getQueryParameter('data') === 'save';
        const localSaveKey = `omrData_${filename || 'default'}`;

        function createQuestionElement(questionText, options, index) {
            const questionDiv = document.createElement('div');
            questionDiv.classList.add('question');

            const questionP = document.createElement('p');
            questionP.innerHTML = `<span class="question-number">${index + 1}.</span> ${questionText}`;
            questionDiv.appendChild(questionP);

            options.forEach((option, optIndex) => {
                const label = document.createElement('label');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.name = `question${index}`;
                checkbox.value = option;

                label.appendChild(checkbox);
                label.appendChild(document.createTextNode(` ${option}`));
                questionDiv.appendChild(label);
            });

            questionsContainer.appendChild(questionDiv);
        }

        function updateQuestionColors() {
            const questions = document.querySelectorAll('.question');
            const tempInput = [];

            questions.forEach((question, index) => {
                const checkboxes = question.querySelectorAll('input[type="checkbox"]');
                const selectedOptions = Array.from(checkboxes).filter(checkbox => checkbox.checked).map(cb => cb.value);

                if (selectedOptions.length === 1) {
                    question.classList.add('green');
                    question.classList.remove('blue', 'red');
                } else if (selectedOptions.length > 1) {
                    question.classList.add('blue');
                    question.classList.remove('green', 'red');
                } else {
                    question.classList.add('red');
                    question.classList.remove('green', 'blue');
                }

                tempInput[index] = selectedOptions;
            });

            // ✅ Auto save to localStorage if enabled
            if (autoSaveEnabled) {
                localStorage.setItem(localSaveKey, JSON.stringify(tempInput));
            }
        }

        function processJSON(userInput) {
            questionsContainer.innerHTML = '';

            userInput.forEach((answers, index) => {
                createQuestionElement("Question " + (index + 1), ["A", "B", "C", "D"], index);
            });

            const questionDivs = document.querySelectorAll('.question');
            userInput.forEach((answers, index) => {
                const checkboxes = questionDivs[index].querySelectorAll('input[type="checkbox"]');
                answers.forEach(ans => {
                    checkboxes.forEach(checkbox => {
                        if (checkbox.value === ans) {
                            checkbox.checked = true;
                        }
                    });
                });
            });

            updateQuestionColors();

            // Add listeners to checkboxes to update colors and save
            document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', updateQuestionColors);
            });
        }

        function getUserSelections() {
            const selections = [];
            const questionDivs = document.querySelectorAll('.question');

            questionDivs.forEach(question => {
                const selected = Array.from(question.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
                selections.push(selected);
            });

            return selections;
        }

        saveButton.addEventListener('click', () => {
            const userInput = getUserSelections();
            const blob = new Blob([JSON.stringify(userInput, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = filename || 'answer_key.json';
            a.click();
        });

        // ✅ Reset button clears saved data
        resetButton.addEventListener('click', () => {
            if (confirm("Are you sure you want to clear all saved data?")) {
                localStorage.removeItem(localSaveKey);
                location.reload();
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            if (filename) {
                fetch(filename)
                    .then(response => response.json())
                    .then(data => {
                        // ✅ Load from localStorage if available
                        if (autoSaveEnabled) {
                            const savedData = localStorage.getItem(localSaveKey);
                            if (savedData) {
                                try {
                                    const parsed = JSON.parse(savedData);
                                    processJSON(parsed);
                                    return;
                                } catch (e) {
                                    console.error("Error parsing saved data:", e);
                                }
                            }
                        }

                        processJSON(data);
                    })
                    .catch(error => {
                        console.error('Error loading the JSON file:', error);
                    });
            }
        });
    </script>
</body>
</html>
