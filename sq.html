<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Square Contour Detection</title>
    <style>
        body {
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #000;
        }
        video, canvas {
            position: absolute;
            width: 100vw;
            height: 100vh;
            object-fit: cover;
        }
    </style>
</head>
<body>
    <video id="video" playsinline autoplay></video>
    <canvas id="canvas"></canvas>

    <script async src="https://docs.opencv.org/4.x/opencv.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const context = canvas.getContext('2d');
            
            const constraints = {
                video: {
                    facingMode: 'environment', // Use the rear camera on mobile devices
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                }
            };

            navigator.mediaDevices.getUserMedia(constraints)
                .then(stream => {
                    video.srcObject = stream;
                })
                .catch(err => console.error('Error accessing media devices.', err));

            video.addEventListener('play', () => {
                const cap = new cv.VideoCapture(video);
                
                const processFrame = () => {
                    let src = new cv.Mat(video.height, video.width, cv.CV_8UC4);
                    let dst = new cv.Mat();
                    cap.read(src);
                    cv.cvtColor(src, dst, cv.COLOR_RGBA2GRAY);
                    cv.threshold(dst, dst, 120, 255, cv.THRESH_BINARY);
                    let contours = new cv.MatVector();
                    let hierarchy = new cv.Mat();
                    cv.findContours(dst, contours, hierarchy, cv.RETR_TREE, cv.CHAIN_APPROX_SIMPLE);

                    context.drawImage(video, 0, 0, canvas.width, canvas.height);
                    context.lineWidth = 3;
                    context.strokeStyle = 'green';

                    for (let i = 0; i < contours.size(); ++i) {
                        const contour = contours.get(i);
                        const approx = new cv.Mat();
                        cv.approxPolyDP(contour, approx, 0.04 * cv.arcLength(contour, true), true);
                        
                        if (approx.rows === 4) {
                            const points = [];
                            for (let j = 0; j < 4; ++j) {
                                points.push({ x: approx.data32S[j*2], y: approx.data32S[j*2 + 1] });
                            }
                            context.beginPath();
                            context.moveTo(points[0].x, points[0].y);
                            points.forEach(point => context.lineTo(point.x, point.y));
                            context.closePath();
                            context.stroke();
                        }
                        approx.delete();
                        contour.delete();
                    }

                    src.delete();
                    dst.delete();
                    contours.delete();
                    hierarchy.delete();

                    requestAnimationFrame(processFrame);
                };

                requestAnimationFrame(processFrame);
            });
        });
    </script>
</body>
</html>
