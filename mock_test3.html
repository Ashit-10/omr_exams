<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart Board Test System</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

<style>
body { background-color: #fcfcfc; overflow-x: hidden; touch-action: none; font-family: sans-serif; }
.test-container { padding: 20px; position: relative; min-height: 100vh; z-index: 1; }

/* Question Box styling */
.question-box { 
    border: 1px solid #ddd; 
    border-radius: 15px; 
    padding: 25px; 
    background-color: #fff; 
    margin-top: 60px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    position: relative;
    z-index: 10; /* Keep text above canvas until pen is on */
}

.option-label { 
    display: flex; 
    padding: 15px; 
    border: 2px solid #f0f0f0; 
    border-radius: 10px; 
    cursor: pointer; 
    margin-bottom: 12px; 
    background: #fff;
}
.options input[type="radio"] { display: none; }

/* Floating Smart Menu */
.smart-menu-container {
  position: fixed; bottom: 30px; left: 30px; z-index: 2000;
  display: flex; flex-direction: column-reverse; align-items: flex-start; gap: 15px;
}
#fab-main {
  width: 60px; height: 60px; border-radius: 50%; background: #222; color: #fff;
  display: flex; align-items: center; justify-content: center; font-size: 28px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.3); border: none; cursor: pointer;
}
.toolbox-panel {
  background: white; padding: 15px; border-radius: 15px; box-shadow: 0 8px 25px rgba(0,0,0,0.2);
  display: none; flex-direction: column; gap: 15px; border: 1px solid #eee; width: 200px;
}

/* Canvas Logic */
#drawing-canvas { position: absolute; top: 0; left: 0; pointer-events: none; z-index: 500; }
.canvas-active { pointer-events: auto !important; z-index: 1500 !important; }

#score-tag { position: fixed; top: 20px; right: 20px; z-index: 1000; }
.tool-btn-active { background-color: #000 !important; color: #fff !important; }
</style>
</head>

<body>

<div class="test-container" id="main-container">
  <canvas id="drawing-canvas"></canvas>

  <div id="score-tag">
    <span id="score-banner" class="badge bg-dark p-2 fs-6">Score: 0</span>
  </div>

  <div class="smart-menu-container">
    <button id="fab-main" onclick="toggleMenu()"><i class="bi bi-pencil-fill"></i></button>
    <div id="toolbox" class="toolbox-panel">
        <div class="d-flex gap-1">
            <button id="btn-pen" class="btn btn-sm btn-outline-dark w-50" onclick="setTool('pen')">Pen</button>
            <button id="btn-eraser" class="btn btn-sm btn-outline-dark w-50" onclick="setTool('eraser')">Eraser</button>
        </div>
        <div>
            <label class="small fw-bold">Color</label>
            <input type="color" id="pen-color" value="#0000ff" class="form-control form-control-color w-100 border-0">
        </div>
        <div>
            <label class="small fw-bold">Thickness</label>
            <input type="range" id="pen-size" min="1" max="30" value="4" class="form-range">
        </div>
        <button class="btn btn-sm btn-danger w-100" onclick="clearCanvas()">Clear All</button>
    </div>
  </div>

  <div id="questions-container" class="container">
      <div class="text-center mt-5">Loading Questions...</div>
  </div>

  <div class="container d-flex justify-content-between mt-5 pb-5">
    <button class="btn btn-outline-dark px-4" onclick="prevQuestion()">Prev</button>
    <button class="btn btn-dark px-5" onclick="nextQuestion()">Next</button>
  </div>
</div>

<script>
let questions = [];
let score = 0;
let currentQuestionIndex = 0;
const canvas = document.getElementById('drawing-canvas');
const ctx = canvas.getContext('2d');
let drawing = false;
let currentTool = 'off';

function toggleMenu() {
    const box = document.getElementById('toolbox');
    const isVisible = box.style.display === 'flex';
    box.style.display = isVisible ? 'none' : 'flex';
    if (!isVisible && currentTool === 'off') setTool('pen');
    if (isVisible) setTool('off');
}

function setTool(tool) {
    currentTool = tool;
    document.getElementById('btn-pen').classList.remove('tool-btn-active');
    document.getElementById('btn-eraser').classList.remove('tool-btn-active');
    if (tool !== 'off') {
        canvas.classList.add('canvas-active');
        document.getElementById('btn-' + tool).classList.add('tool-btn-active');
    } else {
        canvas.classList.remove('canvas-active');
    }
}

// Crisp Stroke Logic
function setupCanvas() {
    const dpr = window.devicePixelRatio || 1;
    const fullHeight = Math.max(document.body.scrollHeight, document.documentElement.scrollHeight);
    canvas.style.width = window.innerWidth + 'px';
    canvas.style.height = fullHeight + 'px';
    canvas.width = window.innerWidth * dpr;
    canvas.height = fullHeight * dpr;
    ctx.scale(dpr, dpr);
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
}

function clearCanvas() {
    ctx.save();
    ctx.setTransform(1, 0, 0, 1, 0, 0);
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.restore();
}

function getPos(e) {
    const clientX = e.clientX || (e.touches && e.touches[0].clientX);
    const clientY = e.clientY || (e.touches && e.touches[0].clientY);
    return { x: clientX + window.scrollX, y: clientY + window.scrollY };
}

function startDrawing(e) {
    if(currentTool === 'off') return;
    drawing = true;
    const pos = getPos(e);
    ctx.beginPath();
    if (currentTool === 'eraser') {
        ctx.globalCompositeOperation = 'destination-out';
        ctx.lineWidth = document.getElementById('pen-size').value * 4;
    } else {
        ctx.globalCompositeOperation = 'source-over';
        ctx.strokeStyle = document.getElementById('pen-color').value;
        ctx.lineWidth = document.getElementById('pen-size').value;
    }
    ctx.moveTo(pos.x, pos.y);
}

function draw(e) {
    if (!drawing || currentTool === 'off') return;
    const pos = getPos(e);
    ctx.lineTo(pos.x, pos.y);
    ctx.stroke();
}

window.addEventListener('mouseup', () => drawing = false);
canvas.addEventListener('mousedown', startDrawing);
canvas.addEventListener('mousemove', draw);
canvas.addEventListener('touchstart', (e) => { startDrawing(e); e.preventDefault(); }, {passive: false});
canvas.addEventListener('touchmove', (e) => { draw(e); e.preventDefault(); }, {passive: false});

// ---------- DATA LOADING ----------
const urlParams = new URLSearchParams(window.location.search);
const fileLoc = urlParams.get('file');

if (!fileLoc) {
    document.getElementById('questions-container').innerHTML = "<div class='alert alert-danger'>Error: No file parameter in URL. (Use ?file=foldername)</div>";
} else {
    Promise.all([
        fetch(fileLoc + "/question.txt").then(r => r.text()),
        fetch(fileLoc + "/answer.txt").then(r => r.json())
    ])
    .then(([qText, ans]) => {
        const lines = qText.split('\n').filter(l => l.trim() !== '');
        let q = null, list = [];
        lines.forEach(line => {
            if (/^\d+\./.test(line)) {
                if (q) list.push(q);
                q = { question: line.replace(/^\d+\.\s*/, ""), options: [] };
            } else if (/^[A-D]\)/.test(line)) {
                q.options.push(line.replace(/^[A-D]\)\s*/, ""));
            }
        });
        if (q) list.push(q);
        questions = list.map((q, i) => ({
            question: q.question, options: q.options,
            correct: ans[i+1].map(x => x.charCodeAt(0) - 65)
        }));
        renderQuestions();
        setupCanvas();
    })
    .catch(err => {
        document.getElementById('questions-container').innerHTML = "<div class='alert alert-danger'>Failed to load files. Check folder path.</div>";
    });
}

function renderQuestions() {
  const container = document.getElementById("questions-container");
  container.innerHTML = "";
  questions.forEach((q, qi) => {
    const box = document.createElement("div");
    box.className = "question-box";
    box.style.display = qi === 0 ? "block" : "none";
    box.innerHTML = `<h5 class='text-muted'>Question ${qi+1}/${questions.length}</h5><p class='fs-4 mt-3'>${q.question}</p><div class='options-list mt-4'></div>`;
    const optDiv = box.querySelector(".options-list");
    q.options.forEach((opt, oi) => {
      const label = document.createElement("label");
      label.className = "option-label";
      label.innerHTML = `<input type="radio" name="q-${qi}"><span class='fw-bold me-3'>${String.fromCharCode(65+oi)})</span> ${opt}`;
      label.querySelector("input").addEventListener("change", () => {
          const correct = q.correct.includes(oi);
          document.querySelectorAll(`input[name="q-${qi}"]`).forEach(i => i.disabled = true);
          if(correct) { label.style.borderColor = "#2ecc71"; label.style.background="#f0fff4"; score++; }
          else { label.style.borderColor = "#e74c3c"; label.style.background="#fff5f5"; }
          document.getElementById('score-banner').innerText = "Score: " + score;
      });
      optDiv.appendChild(label);
    });
    container.appendChild(box);
  });
}

function showQuestion(i) {
    const boxes = document.querySelectorAll(".question-box");
    if(boxes[i]) {
        boxes.forEach(b => b.style.display = "none");
        boxes[i].style.display = "block";
        currentQuestionIndex = i;
    }
}
function nextQuestion() { if (currentQuestionIndex < questions.length - 1) showQuestion(currentQuestionIndex + 1); }
function prevQuestion() { if (currentQuestionIndex > 0) showQuestion(currentQuestionIndex - 1); }

window.addEventListener('resize', setupCanvas);
</script>
</body>
</html>
