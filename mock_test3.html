<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Online Test System</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
body { background-color: #fff; }
.test-container { padding: 20px; position: relative; }
.question-box { border: 1px solid #ddd; border-radius: 8px; padding: 15px; background-color: #fafafa; }
.option-label { display: flex; padding: 12px; border: 2px solid #ddd; border-radius: 6px; cursor: pointer; margin-bottom: 10px; }
.options input[type="radio"] { display: none; }

#notification {
  position: fixed; top: 40%; left: 50%; transform: translateX(-50%);
  padding: 10px 20px; color: white; display: none; font-weight: bold; z-index: 1000;
}
.correct { background: green; }
.incorrect { background: red; }

/* Canvas Styling */
#drawing-canvas {
  position: absolute;
  top: 0; left: 0;
  pointer-events: none; /* Default off */
  z-index: 500;
}
.canvas-active { pointer-events: auto !important; cursor: crosshair; }
.controls-row { gap: 10px; }
</style>
</head>

<body>

<div class="test-container" id="main-container">
  <canvas id="drawing-canvas"></canvas>

  <h3 id="headname">Mock Test</h3>

  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <div id="score-banner">Score: 0</div>
        <div id="questions-left"></div>
    </div>
    <div class="controls-row d-flex">
        <button id="pen-toggle" class="btn btn-outline-dark" onclick="togglePen()">Pen: OFF</button>
        <button class="btn btn-outline-danger" onclick="clearCanvas()">Clear Pen</button>
    </div>
  </div>

  <div id="questions-container"></div>

  <div class="d-flex justify-content-between mt-3">
    <button class="btn btn-secondary" onclick="prevQuestion()">Previous</button>
    <button class="btn btn-primary" onclick="nextQuestion()">Next</button>
  </div>
</div>

<div id="notification"></div>

<script>
let questions = [];
let score = 0;
let currentQuestionIndex = 0;

// ---------- PEN / STYLUS LOGIC ----------
const canvas = document.getElementById('drawing-canvas');
const ctx = canvas.getContext('2d');
let drawing = false;
let penEnabled = false;

function setupCanvas() {
    canvas.width = document.getElementById('main-container').offsetWidth;
    canvas.height = document.getElementById('main-container').offsetHeight;
    ctx.lineWidth = 3;
    ctx.lineCap = 'round';
    ctx.strokeStyle = 'red';
}

function togglePen() {
    penEnabled = !penEnabled;
    const btn = document.getElementById('pen-toggle');
    if (penEnabled) {
        btn.innerText = "Pen: ON";
        btn.className = "btn btn-dark";
        canvas.classList.add('canvas-active');
    } else {
        btn.innerText = "Pen: OFF";
        btn.className = "btn btn-outline-dark";
        canvas.classList.remove('canvas-active');
    }
}

function clearCanvas() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
}

// Mouse/Touch Events
canvas.addEventListener('mousedown', startDrawing);
canvas.addEventListener('mousemove', draw);
canvas.addEventListener('mouseup', stopDrawing);
canvas.addEventListener('touchstart', (e) => { startDrawing(e.touches[0]); e.preventDefault(); });
canvas.addEventListener('touchmove', (e) => { draw(e.touches[0]); e.preventDefault(); });
canvas.addEventListener('touchend', stopDrawing);

function startDrawing(e) {
    if(!penEnabled) return;
    drawing = true;
    ctx.beginPath();
    ctx.moveTo(e.pageX - canvas.offsetLeft, e.pageY - canvas.offsetTop);
}

function draw(e) {
    if (!drawing || !penEnabled) return;
    ctx.lineTo(e.pageX - canvas.offsetLeft, e.pageY - canvas.offsetTop);
    ctx.stroke();
}

function stopDrawing() { drawing = false; }

window.addEventListener('resize', setupCanvas);

// ---------- LOAD QUESTIONS ----------
const urlParams = new URLSearchParams(window.location.search);
const fileLoc = urlParams.get('file');
const questionsFile = fileLoc + "/question.txt";
const answersFile = fileLoc + "/answer.txt";

fetch(questionsFile)
.then(r => r.text())
.then(qText => {
  return fetch(answersFile).then(r => r.json()).then(ans => ({qText, ans}));
})
.then(({qText, ans}) => {
  const lines = qText.split('\n').filter(l => l.trim() !== '');
  let q = null;
  let list = [];

  lines.forEach(line => {
    if (/^\d+\./.test(line)) {
      if (q) list.push(q);
      q = { question: line.replace(/^\d+\.\s*/, ""), options: [] };
    } else if (/^[A-D]\)/.test(line)) {
      q.options.push(line.replace(/^[A-D]\)\s*/, ""));
    }
  });
  if (q) list.push(q);

  questions = list.map((q, i) => {
    return {
      question: q.question,
      options: q.options,
      correct: ans[i+1].map(x => x.charCodeAt(0) - 65)
    };
  });

  renderQuestions();
  setupCanvas(); // Initialize canvas size after questions render
});

// ---------- RENDER ----------
function renderQuestions() {
  const container = document.getElementById("questions-container");
  container.innerHTML = "";

  questions.forEach((q, qi) => {
    const box = document.createElement("div");
    box.className = "question-box";
    box.style.display = "none";
    box.innerHTML = `<b>Question ${qi+1}</b><br>${q.question}<ul class="options mt-3"></ul>`;

    const ul = box.querySelector(".options");
    q.options.forEach((opt, oi) => {
      const li = document.createElement("li");
      li.innerHTML = `<label class="option-label"><input type="radio" name="q-${qi}">${String.fromCharCode(65+oi)}) ${opt}</label>`;
      li.querySelector("input").addEventListener("change", () => handleAnswer(qi, oi, li.querySelector(".option-label")));
      ul.appendChild(li);
    });
    container.appendChild(box);
  });
  showQuestion(0);
  updateUI();
}

// ---------- ANSWER HANDLING ----------
function handleAnswer(qi, oi, label) {
  const correct = questions[qi].correct.includes(oi);
  document.querySelectorAll(`input[name="q-${qi}"]`).forEach(r => r.disabled = true);

  if (correct) {
    label.style.background = "#5cb85c";
    score++;
    showNotification("Correct", "correct");
  } else {
    label.style.background = "#d9534f";
    showNotification("Wrong", "incorrect");
  }
  updateUI();
  // Timer removed here - user must click "Next" manually
}

// ---------- NAVIGATION ----------
function showQuestion(i) {
  document.querySelectorAll(".question-box").forEach((q, idx) => {
    q.style.display = idx === i ? "block" : "none";
  });
  // Optional: clear drawings when switching questions
  // clearCanvas(); 
}

function nextQuestion() {
  if (currentQuestionIndex < questions.length - 1) {
    currentQuestionIndex++;
    showQuestion(currentQuestionIndex);
  }
}

function prevQuestion() {
  if (currentQuestionIndex > 0) {
    currentQuestionIndex--;
    showQuestion(currentQuestionIndex);
  }
}

function updateUI() {
  document.getElementById("score-banner").innerText = `Score: ${score}`;
  document.getElementById("questions-left").innerText =
    `Questions Left: ${questions.length - document.querySelectorAll("input:checked").length}`;
}

function showNotification(msg, cls) {
  const n = document.getElementById("notification");
  n.innerText = msg;
  n.className = cls;
  n.style.display = "block";
  setTimeout(() => n.style.display = "none", 1200);
}
</script>
</body>
</html>
