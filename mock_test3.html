<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Online Test System</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
body { background-color: #fff; overflow-x: hidden; }
.test-container { padding: 20px; position: relative; min-height: 100vh; }
.question-box { border: 1px solid #ddd; border-radius: 8px; padding: 15px; background-color: #fafafa; position: relative; z-index: 1; }
.option-label { display: flex; padding: 12px; border: 2px solid #ddd; border-radius: 6px; cursor: pointer; margin-bottom: 10px; background: white; }
.options input[type="radio"] { display: none; }

/* Control Panel Z-Index Fix */
.controls-overlay {
  position: sticky; top: 10px; z-index: 1001; 
  background: rgba(255,255,255,0.9); padding: 10px; border-radius: 8px; border: 1px solid #ccc;
}

#notification {
  position: fixed; top: 20%; left: 50%; transform: translateX(-50%);
  padding: 10px 20px; color: white; display: none; font-weight: bold; z-index: 2000;
}
.correct { background: green; }
.incorrect { background: red; }

/* Canvas Layer */
#drawing-canvas {
  position: absolute; top: 0; left: 0;
  pointer-events: none; z-index: 500;
}
.canvas-active { pointer-events: auto !important; }
</style>
</head>

<body>

<div class="test-container" id="main-container">
  <canvas id="drawing-canvas"></canvas>

  <div class="controls-overlay mb-3 shadow-sm">
    <div class="d-flex flex-wrap align-items-center gap-3">
        <button id="pen-toggle" class="btn btn-outline-dark" onclick="togglePen()">Pen: OFF</button>
        <button class="btn btn-outline-danger" onclick="clearCanvas()">Clear</button>
        
        <div class="d-flex align-items-center gap-2">
            <label class="small fw-bold">Color:</label>
            <input type="color" id="pen-color" value="#ff0000" class="form-control form-control-color form-control-sm">
        </div>

        <div class="d-flex align-items-center gap-2">
            <label class="small fw-bold">Size:</label>
            <input type="range" id="pen-size" min="1" max="15" value="3" class="form-range" style="width:100px;">
        </div>

        <div class="ms-auto">
            <span id="score-banner" class="badge bg-primary fs-6">Score: 0</span>
        </div>
    </div>
  </div>

  <div id="questions-container"></div>

  <div class="d-flex justify-content-between mt-4 pb-5">
    <button class="btn btn-secondary px-4" onclick="prevQuestion()">Previous</button>
    <button class="btn btn-primary px-4" onclick="nextQuestion()">Next</button>
  </div>
</div>

<div id="notification"></div>

<script>
let questions = [];
let score = 0;
let currentQuestionIndex = 0;

const canvas = document.getElementById('drawing-canvas');
const ctx = canvas.getContext('2d');
let drawing = false;
let penEnabled = false;

// Setup Canvas Size
function setupCanvas() {
    canvas.width = document.documentElement.scrollWidth;
    canvas.height = document.documentElement.scrollHeight;
}

function togglePen() {
    penEnabled = !penEnabled;
    const btn = document.getElementById('pen-toggle');
    if (penEnabled) {
        btn.innerText = "Pen: ON";
        btn.className = "btn btn-dark";
        canvas.classList.add('canvas-active');
    } else {
        btn.innerText = "Pen: OFF";
        btn.className = "btn btn-outline-dark";
        canvas.classList.remove('canvas-active');
    }
}

function clearCanvas() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
}

// Drawing Logic
function getPos(e) {
    const rect = canvas.getBoundingClientRect();
    const clientX = e.clientX || (e.touches && e.touches[0].clientX);
    const clientY = e.clientY || (e.touches && e.touches[0].clientY);
    return {
        x: clientX - rect.left,
        y: clientY - rect.top
    };
}

function startDrawing(e) {
    if(!penEnabled) return;
    drawing = true;
    const pos = getPos(e);
    ctx.beginPath();
    ctx.strokeStyle = document.getElementById('pen-color').value;
    ctx.lineWidth = document.getElementById('pen-size').value;
    ctx.lineCap = 'round';
    ctx.moveTo(pos.x, pos.y);
}

function draw(e) {
    if (!drawing || !penEnabled) return;
    const pos = getPos(e);
    ctx.lineTo(pos.x, pos.y);
    ctx.stroke();
}

function stopDrawing() { drawing = false; }

canvas.addEventListener('mousedown', startDrawing);
canvas.addEventListener('mousemove', draw);
canvas.addEventListener('mouseup', stopDrawing);
canvas.addEventListener('touchstart', (e) => { startDrawing(e); e.preventDefault(); }, {passive: false});
canvas.addEventListener('touchmove', (e) => { draw(e); e.preventDefault(); }, {passive: false});
canvas.addEventListener('touchend', stopDrawing);

// ---------- LOAD DATA ----------
const urlParams = new URLSearchParams(window.location.search);
const fileLoc = urlParams.get('file');
const questionsFile = fileLoc + "/question.txt";
const answersFile = fileLoc + "/answer.txt";

fetch(questionsFile)
.then(r => r.text())
.then(qText => fetch(answersFile).then(r => r.json()).then(ans => ({qText, ans})))
.then(({qText, ans}) => {
  const lines = qText.split('\n').filter(l => l.trim() !== '');
  let q = null;
  let list = [];
  lines.forEach(line => {
    if (/^\d+\./.test(line)) {
      if (q) list.push(q);
      q = { question: line.replace(/^\d+\.\s*/, ""), options: [] };
    } else if (/^[A-D]\)/.test(line)) {
      q.options.push(line.replace(/^[A-D]\)\s*/, ""));
    }
  });
  if (q) list.push(q);
  questions = list.map((q, i) => ({
    question: q.question,
    options: q.options,
    correct: ans[i+1].map(x => x.charCodeAt(0) - 65)
  }));
  renderQuestions();
  setTimeout(setupCanvas, 500); // Wait for render to set height
});

function renderQuestions() {
  const container = document.getElementById("questions-container");
  container.innerHTML = "";
  questions.forEach((q, qi) => {
    const box = document.createElement("div");
    box.className = "question-box";
    box.style.display = qi === 0 ? "block" : "none";
    box.innerHTML = `<b>Question ${qi+1}</b><br>${q.question}<ul class="options mt-3 list-unstyled"></ul>`;
    const ul = box.querySelector(".options");
    q.options.forEach((opt, oi) => {
      const li = document.createElement("li");
      li.innerHTML = `<label class="option-label"><input type="radio" name="q-${qi}">${String.fromCharCode(65+oi)}) ${opt}</label>`;
      li.querySelector("input").addEventListener("change", () => handleAnswer(qi, oi, li.querySelector(".option-label")));
      ul.appendChild(li);
    });
    container.appendChild(box);
  });
}

function handleAnswer(qi, oi, label) {
  const correct = questions[qi].correct.includes(oi);
  document.querySelectorAll(`input[name="q-${qi}"]`).forEach(r => r.disabled = true);
  if (correct) {
    label.style.background = "#d4edda";
    label.style.borderColor = "#28a745";
    score++;
    showNotification("Correct!", "correct");
  } else {
    label.style.background = "#f8d7da";
    label.style.borderColor = "#dc3545";
    showNotification("Incorrect", "incorrect");
  }
  document.getElementById("score-banner").innerText = `Score: ${score}`;
}

function showQuestion(i) {
  const boxes = document.querySelectorAll(".question-box");
  boxes.forEach((box, idx) => box.style.display = idx === i ? "block" : "none");
  currentQuestionIndex = i;
}

function nextQuestion() {
  if (currentQuestionIndex < questions.length - 1) showQuestion(currentQuestionIndex + 1);
}

function prevQuestion() {
  if (currentQuestionIndex > 0) showQuestion(currentQuestionIndex - 1);
}

function showNotification(msg, cls) {
  const n = document.getElementById("notification");
  n.innerText = msg; n.className = cls; n.style.display = "block";
  setTimeout(() => n.style.display = "none", 1000);
}

window.addEventListener('resize', setupCanvas);
</script>
</body>
</html>
